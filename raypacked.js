var s=128,t=192,v=224,aa=s>>1,w=270,x=0,y,z,A,ba,C=Math.PI/180,ca=1/C,E=19,F=16,H=64,I=64,J=[0,0,0],K=320,L=240,M=128,N=64,O=30,da=60/K,P=(K>>1)/Math.tan(O*C),Q=L>>1,ea=K,R=ea*4,S,T,fa=[],ga=!1,U=[],V=[],ha=[],ia=[],W,X=0,Y=0,ja=!1,Z=[{h:10,i:10,f:4,a:0,d:0,c:!0,fixed:!0,g:!0},{x:384,y:736,f:5,a:0,d:0,c:!0,fixed:!1,e:5,b:0,j:0}],$=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,1,0,0,0,0,0,0,0,0,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,19],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,11],[1,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,19],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],[1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0],[1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,2,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0]];
function ka(a,e){var c=document.getElementById(a);U[e]=Array(M);T.clearRect(0,0,K,L);T.drawImage(c,0,0);for(var c=T.getImageData(0,0,N,M),d=0;d<M;d++){U[e][d]=Array(N);for(var f=0;f<N;f++)U[e][d][f]=[c.data[d*256+f*4],c.data[d*256+f*4+1],c.data[d*256+f*4+2],c.data[d*256+f*4+3]]}}
function la(){V[65]&&(moving_backward?A-=4:A+=4);V[68]&&(moving_backward?A+=4:A-=4);if(V[87]){var a=w%360,e=1,c=0,e=10*Math.cos(a*C),c=-10*Math.sin(a*C);y+=e;z+=c;moving_backward=!1}V[80]&&console.log(t,v,w);V[83]&&(a=w%360,e=1,c=0,e=10*Math.cos(a*C),c=10*Math.sin(a*C),e*=-1,c*=-1,y+=e,z-=c,moving_backward=!1);if(V[32]&&!ia[32]){ja&&($[11][7]=0);for(a=Z.length-1;a>=0;a--)if(!Z[a].fixed&&Z[a].a<150)ia[32]=!0,Z[a].e--,Z[a].b=10,Z[a].e<=0&&Z.splice(a,1)}X++;X%2===0&&(Y++,Y>3&&(Y=0));Math.abs(w-A)<1.0E-4&&
(w=A);Math.abs(y-t)<0.0010&&(moving_backward=!1,t=y);Math.abs(z-v)<0.0010&&(moving_backward=!1,v=z);var a=y-t,e=z-v,c=A-w,d=ba-x;a*=0.3;e*=0.3;c*=0.3;d*=0.7;t+=a;v+=e;w+=c;x+=d;Q=L/2+x|0;c=$[v/I|0][t/H|0];c!==0&&c!==14&&(t-=a,v-=e,y=t,z=v);ga&&(t-=5*a,v-=5*e,y=t,z=v);w>360&&(w-=360,A-=360);w<0&&(w=360+w,A=360+A);ma();for(a=0;a<3;a++)J[a]>0?J[a]-=0.2:J[a]=0}
function ma(){for(var a=(w+O)%360,e=0,c=W.data,d=0;d<K;d++){var f=na(a,!1);f[2]!=-1&&(ha[f[2]]&&(f=na(a,!0)),f[2]==14&&(f[2]+=Y),e=f[0],e*=Math.cos((a-w)*C),fa[d]=e,e=s/e*P|0,oa(c,d,Q-(e>>1),e,f[1]|0,f[2],a),a-=da,a<=0&&(a=360-a))}T.putImageData(W,0,0);pa();Z.sort(function(a,c){return c.a-a.a});for(d=a=0;d<Z.length;d++)Z[d].c&&(qa(Z[d]),a++)}
function pa(){var a=Math.cos(w*C),e=Math.sin(w*C);ga=!1;for(var c=Z.length-1;c>=0;c--){var d=Z[c],f,j;d.fixed?(f=d.h*H+(H>>1),j=d.i*I+(I>>1)):(f=d.x,j=d.y,d.b>0&&Z[c].b--);f-=t;var q=v-j;j=Math.sqrt(f*f+q*q);j<80&&d.g?(Z.splice(c,1),J[0]=1,J[1]=1,J[2]=3,ja=!0):(j<80&&!d.fixed&&(ga=!0,J[0]<0.5&&(J[0]=0.8,J[1]=0.1,J[2]=0.1)),Math.acos(f/j*a+q/j*e)*ca>O+5?d.c=!1:(d.c=!0,f=Math.atan2(q,f)-w*C,d.a=j*Math.cos(f),d.d=f))}}
function qa(a){var e,c,d=a.f,f=a.a,j=a.d,q=0;d==4&&(c=28,e=31);d==5&&(c=50,e=49,q=30-5*Math.sin(X/10));d==25&&(c=e=25,d+=X%8>>1);if(!(f<H)){var k=e/f*P|0,l=c/f*P|0,q=((s-e>>1)-q)/f*P|0,o=(K>>1)-Math.tan(j)*P,j=Math.round(o-l/2);if(!(o+l/2<0||j>=K)){var o=l,m=k,G=0;j+l>=K&&(o=K-j);j<0&&(G=-j,j=0);var u,D;c=(c-1)/l;l=(e-1)/k;e=(L>>1)-(k>>1);if(!(e+q>L)&&(e+q+k>=L&&(m=L-q-e),m!==0)){imageData=T.getImageData(j,e+q,o,m);data=imageData.data;for(var i=m=0;i<k;i++){D=Math.round(i*l);for(var p=0;p<o;p++)u=
Math.round((p+G)*c),fa[j+p]>f&&U[d][D][u][3]===255?(r=U[d][D][u][0],g=U[d][D][u][1],b=U[d][D][u][2],a.b>0&&(r<<=1,g>>=2,b>>=2),data[m++]=r,data[m++]=g,data[m++]=b,data[m++]=U[d][D][u][3]):m+=4}T.putImageData(imageData,j,e+q)}}}}
function na(a,e){var c=a*C,d=a>=0&&a<=180,f=a>=90&&a<=270,j=Math.tan(c),q=Math.cos(c),c=Math.sin(c),k=0,l=0;d?(k=(v/I|0)*I-1,l=-I):(l=I,k=(v/I|0)*I+I);var o=I/j,o=f?-Math.abs(o):Math.abs(o),m=t+(v-k)/j,G=Number.MAX_VALUE,u=-1,D=-1,i=0,p=m/H|0,h=k/I|0;if(p>=0&&p<E&&h>=0&&h<F){do{if($[h][p]>0&&(!e||!ha[$[h][p]])){i=Math.abs((k-v)/c);i<G&&(G=i,u=m%N,h>v/I&&(u=N-1-u),D=$[h][p]);break}m+=o;k+=l;p=m/H|0;h=k/I|0}while(m>=0&&m<H*E&&k>=0&&k<I*F)}f?(m=(t/H|0)*H-1,o=-H):(m=(t/H|0)*H+H,o=H);l=H*j;l=d?-Math.abs(l):
Math.abs(l);k=v+(t-m)*j;p=m/H|0;h=k/I|0;if(p>=0&&p<E&&h>=0&&h<F){do{if($[h][p]>0&&(!e||!ha[$[h][p]])){i=Math.abs((m-t)/q);i<G&&(G=i,u=k%N,p<t/H&&(u=N-1-u),D=$[h][p]);break}m+=o;k+=l;p=m/H|0;h=k/I|0}while(m>=0&&m<H*E&&k>=0&&k<I*F)}return[G,u,D,!1]}
function oa(a,e,c,d,f,j,q){if(!(j<0)){var k=0,l=e*4,o=0,m=0,G=M/d;d|=0;c>0?(k=c,l+=c*R):m=-c*G;var u=q*C,D=Math.cos(u),u=Math.sin(u),i=Math.cos((w-q)*C),o=c-1,c=o*R+e*4,p,h,n,B,q=-D;p=u;for(e=aa*P/i;o>=0;)i=o-Q,h=e/i,i=q*h,h*=p,n=t+i,B=v+h,grid_x=n/64|0,grid_y=B/64|0,n=(n|0)%64,B=(B|0)%64,i=U[3][B][n][0],h=U[3][B][n][1],n=U[3][B][n][2],i+=i*J[0],h+=h*J[1],n+=n*J[2],a[c]=i,a[c+1]=h,a[c+2]=n,o--,c-=R;for(c=0;c<d;c++){if(k>=L)break;o=m+G*c|0;i=U[j][o][f][0];h=U[j][o][f][1];n=U[j][o][f][2];i===0&&h===
255&&n===255?l+=R:(i+=i*J[0],h+=h*J[1],n+=n*J[2],a[l++]=i,a[l++]=h,a[l++]=n,l++,l+=R-4);k++}q=D;for(p=-u;k<L;)i=k-Q,h=e/i,i=q*h,h*=p,n=t+i,B=v+h,grid_x=n/64|0,grid_y=B/64|0,n=(n|0)%64,B=(B|0)%64,i=U[1][B][n][0],h=U[3][B][n][1],n=U[3][B][n][2],i+=i*J[0],h+=h*J[1],n+=n*J[2],a[l++]=i,a[l++]=h,a[l++]=n,l++,l+=R-4,k++}}
window.raycaster=function(){document.addEventListener("keydown",function(a){V[a.keyCode]=!0},!0);document.addEventListener("keyup",function(a){V[a.keyCode]=!1;ia[a.keyCode]=!1},!0);y=t;z=v;A=w;ba=x;S=document.getElementById("surface");S.width=K;S.height=L;S.style.width="640px";S.style.height="480px";T=S.getContext("2d");W=T.createImageData(ea,L);for(var a=0;a<W.data.length;a++)W.data[a]=255;for(a=1;a<=5;a++)ka("wall"+a,a);la();setInterval(la,1E3/60)};
